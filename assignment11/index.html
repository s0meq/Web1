<!DOCTYPE html>
<html lang="fi">
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verkkokauppa – t11</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background-color: #f4f4f4; }
    input, select, button { padding: 5px; margin: 5px; }
    .alert { padding: 10px; margin-top: 10px; display: none; }
    .success { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }
    .cart { border:1px solid #ddd; padding:10px; margin-top:10px;}
  </style>
</head>
<body>

<h1>Verkkokauppa – mallisovellus</h1>

<!-- Hakukenttä ja dropdownit -->
<div>
  <input type="text" id="search" placeholder="Hae nimellä...">
  <select id="categoryFilter">
    <option value="" selected="selected">Kaikki kategoriat</option>
    <option value="beauty">beauty</option>
    <option value="fragrances">fragrances</option>
    <option value="furniture">furniture</option>
    <option value="groceries">groceries</option>
    <option value="home-decoration">home-decoration</option>
    <option value="kitchen-accessories">kitchen-accessories</option>
    <option value="laptops">laptops</option>
    <option value="mens-shirts">mens-shirts</option>
    <option value="mens-shoes">mens-shoes</option>
    <option value="mens-watches">mens-watches</option>
    <option value="mobile-accessories">mobile-accessories</option>
    <option value="motorcycle">motorcycle</option>
    <option value="skin-care">skin-care</option>
    <option value="smartphones">smartphones</option>
    <option value="sports-accessories">sports-accessories</option>
    <option value="sunglasses">sunglasses</option>
    <option value="tablets">tablets</option>
    <option value="tops">tops</option>
    <option value="vehicle">vehicle</option>
    <option value="womens-bags">womens-bags</option>
    <option value="womens-dresses">womens-dresses</option>
    <option value="womens-jewellery">womens-jewellery</option>
    <option value="womens-shoes">womens-shoes</option>
    <option value="womens-watches">womens-watches</option>
  </select>
  <select id="sort">
    <option value="" selected="selected">Lajittelu</option>
    <option value="name-asc">Nimi A–Z</option>
    <option value="name-desc">Nimi Z–A</option>
    <option value="price-asc">Hinta nousevasti</option>
    <option value="price-desc">Hinta laskevasti</option>
  </select>
</div>

<!-- Tuotetaulukko -->
<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Nimi</th>
      <th>Kategoria</th>
      <th>Hinta</th>
      <th>Toiminnot</th>
    </tr>
  </thead>
  <tbody id="productTable"><tr> 
    <td>1</td>
    <td><input value="Essence Mascara Lash Princess" data-id="1" class="editName"></td>
    <td>beauty</td>
    <td><input type="number" value="9.99" data-id="1 class=" editprice"=""></td>
    <td><button data-id="1" class="deleteBtn">Poista</button></td>
    <td><button data-id="1" class="addCartBtn">Lisää koriin</button></td>
    </tr><tr> 
    <td>2</td>
    <td><input value="Eyeshadow Palette with Mirror" data-id="2" class="editName"></td>
    <td>beauty</td>
    <td><input type="number" value="19.99" data-id="2 class=" editprice"=""></td>
    <td><button data-id="2" class="deleteBtn">Poista</button></td>
    <td><button data-id="2" class="addCartBtn">Lisää koriin</button></td>
    </tr><tr> 
    <td>3</td>
    <td><input value="Powder Canister" data-id="3" class="editName"></td>
    <td>beauty</td>
    <td><input type="number" value="14.99" data-id="3 class=" editprice"=""></td>
    <td><button data-id="3" class="deleteBtn">Poista</button></td>
    <td><button data-id="3" class="addCartBtn">Lisää koriin</button></td>
    </tr><tr> 
    <td>4</td>
    <td><input value="Red Lipstick" data-id="4" class="editName"></td>
    <td>beauty</td>
    <td><input type="number" value="12.99" data-id="4 class=" editprice"=""></td>
    <td><button data-id="4" class="deleteBtn">Poista</button></td>
    <td><button data-id="4" class="addCartBtn">Lisää koriin</button></td>
    </tr><tr> 
    <td>5</td>
    <td><input value="Red Nail Polish" data-id="5" class="editName"></td>
    <td>beauty</td>
    <td><input type="number" value="8.99" data-id="5 class=" editprice"=""></td>
    <td><button data-id="5" class="deleteBtn">Poista</button></td>
    <td><button data-id="5" class="addCartBtn">Lisää koriin</button></td>
    </tr><tr> 
    <td>6</td>
    <td><input value="Calvin Klein CK One" data-id="6" class="editName"></td>
    <td>fragrances</td>
    <td><input type="number" value="49.99" data-id="6 class=" editprice"=""></td>
    <td><button data-id="6" class="deleteBtn">Poista</button></td>
    <td><button data-id="6" class="addCartBtn">Lisää koriin</button></td>
    </tr><tr> 
    <td>7</td>
    <td><input value="Chanel Coco Noir Eau De" data-id="7" class="editName"></td>
    <td>fragrances</td>
    <td><input type="number" value="129.99" data-id="7 class=" editprice"=""></td>
    <td><button data-id="7" class="deleteBtn">Poista</button></td>
    <td><button data-id="7" class="addCartBtn">Lisää koriin</button></td>
    </tr><tr> 
    <td>8</td>
    <td><input value="Dior J'adore" data-id="8" class="editName"></td>
    <td>fragrances</td>
    <td><input type="number" value="89.99" data-id="8 class=" editprice"=""></td>
    <td><button data-id="8" class="deleteBtn">Poista</button></td>
    <td><button data-id="8" class="addCartBtn">Lisää koriin</button></td>
    </tr><tr> 
    <td>9</td>
    <td><input value="Dolce Shine Eau de" data-id="9" class="editName"></td>
    <td>fragrances</td>
    <td><input type="number" value="69.99" data-id="9 class=" editprice"=""></td>
    <td><button data-id="9" class="deleteBtn">Poista</button></td>
    <td><button data-id="9" class="addCartBtn">Lisää koriin</button></td>
    </tr><tr> 
    <td>10</td>
    <td><input value="Gucci Bloom Eau de" data-id="10" class="editName"></td>
    <td>fragrances</td>
    <td><input type="number" value="79.99" data-id="10 class=" editprice"=""></td>
    <td><button data-id="10" class="deleteBtn">Poista</button></td>
    <td><button data-id="10" class="addCartBtn">Lisää koriin</button></td>
    </tr></tbody>
</table>

<div class="pagination">
  <button id="prevPage">Edellinen sivu</button>
  <button id="nextPage">Seuraava sivu</button>
</div>

<div class="cart">
  <h2>Ostoskori</h2>
  <ul id="cartItems"></ul>
  <div id="cartTotal"></div>
</div>

<h2>Asiakastiedot</h2>
<div>
  <input type="text" id="name" placeholder="Nimi">
  <input type="text" id="email" placeholder="Sähköposti">
  <input type="text" id="postCode" placeholder="Postinumero">
  <input type="text" id="city" placeholder="Toimipaikka" readonly="readonly">
</div>

<div id="alert" class="alert"></div>
<script>
  /*
Yleiskuvaus koodista:

Tämä verkkokauppa-mallisovellus sisältää seuraavat päätoiminnot:

1️⃣ Tuotteiden haku ja näyttö
- Haetaan tuotteet API:sta (dummyjson.com) sivuittain.
- Tallennetaan tuotteet `products`-taulukkoon ja suodatetut tuotteet `filteredProducts`-taulukkoon.
- Renderöidään HTML-taulukko, jossa voi muokata nimiä ja hintoja, poistaa tuotteita ja lisätä ostoskoriin.

2️⃣ Kategorioiden hallinta
- Haetaan kategoriat API:sta ja täytetään kategorioiden valintalistaan.
- Mahdollistaa tuotteiden suodatuksen kategorian perusteella.

3️⃣ Suodatus ja lajittelu
- `filterProducts()` suodattaa tuotteita hakukentän ja kategorian mukaan.
- `sortProducts()` lajittelee tuotteita nimen tai hinnan perusteella.
- Näiden funktioiden jälkeen kutsutaan aina `renderProducts()`, jotta taulukko päivittyy.

4️⃣ Optimistiset päivitykset
- `updateProduct()` päivittää tuotteen tiedot API:iin heti ja palauttaa vanhan arvon, jos päivitys epäonnistuu.
- `deleteProduct()` poistaa tuotteen välittömästi näkymästä ja palauttaa sen, jos poisto epäonnistuu.

5️⃣ Ostoskori
- `addToCart()` lisää tuotteen ostoskoriin, `renderCart()` näyttää sisällön ja kokonaissumman.
- Ostoskori tallennetaan selaimen `localStorage`iin (`saveCart()`) ja ladataan sivun latauksessa (`loadCart()`).

6️⃣ Postinumero -> Toimipaikka
- Asiakastietojen postinumero-kenttä tarkistaa syötteen blur-tapahtumalla.
- Luetaan paikallinen XML-data ja asetetaan toimipaikka automaattisesti, jos postinumero löytyy.
- Jos postinumeroa ei löydy, näytetään alert-viesti.

7️⃣ Tapahtumakuuntelijat
- Pagination-napit vaihtavat sivua ja hakevat uudet tuotteet.
- Hakukenttä, kategorioiden valinta ja lajittelu kutsuvat suodatus- ja lajittelufunktioita.
- Taulukon napit ja inputit liitetään tapahtumiin, kuten poisto, muokkaus ja lisääminen koriin.

8️⃣ Käyttöliittymän ilmoitukset
- `showAlert()` näyttää lyhytaikaisia viestejä onnistumisesta tai virheestä.
- Ilmoitukset piilotetaan automaattisesti 3 sekunnin jälkeen.

Yhteenveto:
- Koodi yhdistää tuotetiedon haun, suodatuksen, lajittelun ja ostoskorin hallinnan.
- Se mahdollistaa myös käyttäjän syöttämien tietojen, kuten postinumeron, automaattisen tarkistuksen ja täydennyksen.
- Optimistiset päivitykset varmistavat sujuvan käyttökokemuksen, vaikka API-pyynnöt epäonnistuisivat.
- Tallennus paikallisesti (`localStorage`) säilyttää ostoskorin sisällön sivun päivitysten yli.
*/
// perusdata
let products = []; // kaikki haetut tuotteet
let filteredProducts = []; // suodatetut tuotteet jotka näytetään taulukossa
let currentPage = 0; // nykyinen sivu
const pageSize = 10; // montako tuotetta näytetään yhdellä sivulla
let cart = []; // ostoskori, sisältää valitut tuotteet

// hae tuotteet palvelimelta, sivu kerrallaan
async function fetchProducts() {
  try {
    const res = await fetch(`https://dummyjson.com/products?limit=${pageSize}&skip=${currentPage*pageSize}`);
    const data = await res.json();
    products = data.products; // talletetaan haetut tuotteet
    filteredProducts = [...products]; // aluksi kopioidaan kaikki tuotteet
    renderProducts(); // piirretään taulukko
    fetchCategories(); // haetaan tuotekategoriat
  } catch(e) {
    showAlert("Virhe tuotteiden haussa", "error");
  } // catch
}

// tuotteiden tulostus taulukkoon
function renderProducts() {
  const tbody = document.getElementById("productTable");
  tbody.innerHTML = ""; // tyhjennetään vanhat tiedot
  filteredProducts.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = ` 
    <td>${p.id}</td>
    <td><input value="${p.title}" data-id="${p.id}" class="editName"></td>
    <td>${p.category}</td>
    <td><input type="number" value="${p.price}" data-id="${p.id} class="editPrice"></td>
    <td><button data-id="${p.id}" class="deleteBtn">Poista</button></td>
    <td><button data-id="${p.id}" class="addCartBtn">Lisää koriin</button></td>
    `;
    // lisää rivi taulukkoon
    tbody.appendChild(tr);
  });
  attachProductEvents(); // lisätään tapahtumakuuntelijat nappeihin ja inputteihin
} // renderProducts()

// haetaan tuotekategoriat dropdowniin
async function fetchCategories() {
  try {
    const res = await fetch('https://dummyjson.com/products/category-list');
    const categories = await res.json();
    const select = document.getElementById("categoryFilter");
    categories.forEach(cat => {
      const option = document.createElement("option");
      option.value = cat;
      option.textContent = cat;
      select.appendChild(option); // Lisätään kategoria dropdowniin
    });
  } catch(e) {
    showAlert("Virhe kategorioiden haussa", "error");
  }
} // fetchCategories

// suodata tuotteita hakukentän ja kategorian perusteella
function filterProducts() {
  const searchValue = document.getElementById("search").value.toLowerCase();
  const categoryValue = document.getElementById("categoryFilter").value;
  filteredProducts = products.filter(p =>
    p.title.toLowerCase().includes(searchValue) && // hakutermi, molemmat voimassa
    (categoryValue === "" || p.category === categoryValue)
  );
  renderProducts();
} // filterProducts

// lajittelu
function sortProducts() {
  const sortValue = document.getElementById("sort").value;
  if(!sortValue) return; // Ei lajittelua jos tyhjä
  const [key, order] = sortValue.split("-");
  filteredProducts.sort((a,b)=>{
    if(key==="name") return order==="asc"? a.title.localeCompare(b.title) : b.title.localeCompare(a.title);
    if(key==="price") return order==="asc"? a.price - b.price : b.price - a.price;
    return 0;
  });
  renderProducts();
}

function showAlert(msg, type="success") {
  const alertDiv = document.getElementById("alert");
  alertDiv.textContent = msg;
  alertDiv.className=`alert ${type}`;
  alertDiv.style.display="block"; // tuodaan viestidiv näkyville
  setTimeout(()=>alertDiv.style.display="none", 3000); // piilota 3 sekunnin jälkeen
} // showAlert

// tapahtumankäsittelijät
function attachProductEvents() {
  // poista-nappi
  document.querySelectorAll(".deleteBtn").forEach(btn=> {
    // jokaiselle yksittäiselle delete-napille:
    btn.addEventListener("click",()=>deleteProduct(Number(btn.dataset.id)));
  });
  // muokkaa nimi-input
  document.querySelectorAll(".editName").forEach(input=> {
    input.addEventListener("change",()=>updateProduct(Number(input.dataset.id),"title",input.value));
  });
  // lisää koriin-nappi
  document.querySelectorAll(".addCartBtn").forEach(btn=> {
    // jokaiselle yksittäiselle delete-napille:
    btn.addEventListener("click",()=>addToCart(Number(btn.dataset.id)));
  });
  // muokkaa hinta-input
  document.querySelectorAll(".editPrice").forEach(input=> {
    input.addEventListener("change",()=>updateProduct(Number(input.dataset.id),"price",Number(input.value)));
  });

  } // attachProductEvents
// hakufiltteri ja lajittelu
document.getElementById("search").addEventListener("input", filterProducts); // kirjainta syötettäessä
document.getElementById("categoryFilter").addEventListener("change", filterProducts); // kirjainta syötettäessä
document.getElementById("sort").addEventListener("change",sortProducts);          // Lajittelua valitaan

  // tehdään heti alkuun tuotehaku
  fetchProducts();
</script>


</body></html>